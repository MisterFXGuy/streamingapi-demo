<!DOCTYPE html>
<html>
<head>
 <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css" />
 <script src="http://code.jquery.com/jquery-1.8.3.js"></script>
 <script src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
 <script src="http://api-sandbox.oanda.com/ratestream/socket.io.js"></script>
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
 <script src="js/raphael.js"></script>
 <script>
//--------------------------------------------------
    Instruments
//--------------------------------------------------


var currencies = [ "XAU", "XAG", "USD", "MXN", "CAD", "GBP", "EUR", "CHF", "SEK", "HUF", "TRY", "ZAR", "INR", "CNY", "HKD", "SGD", "JPY", "AUD", "NZD" ];

var availablePairs = [];

function splitName ( displayName )
{
   if (displayName.length != 7 ) return [];
  
   if (displayName.charAt(3) != '/') return [];

   return [ displayName.substr(0,3), displayName.substr(4,3) ];
}

function getInstruments( debug ) {
  
   var myinitrequest=new XMLHttpRequest();

   myinitrequest.onreadystatechange = function() {
   
      if (myinitrequest.readyState!=4 || myinitrequest.status!=200 ) return;

      var currencyData = JSON.parse(myinitrequest.responseText);
      
      //for ( var instrument in currencyData.instruments)
      //  if (currencyData.instruments.hasOwnProperty(instrument))

      for(var i = 0; i < currencyData.instruments.length; i++)
      {
          var pairName = currencyData.instruments[i].displayName;
            
          var pair = splitName(pairName);

          if ( pair.length != 2 ) continue;

          if ( currencies.indexOf(pair[0]) < 0 || currencies.indexOf(pair[1]) < 0 ) continue;

          availablePairs.push(pairName);
         
          if ( debug )
          {
              var listItem = document.createElement("li");
              listItem.innerHTML = pair[0] + "/" + pair[1];
              document.getElementById("initlist").appendChild(listItem);
          }
      }
   }

   myinitrequest.open("GET", "http://api-sandbox.oanda.com/v1/instruments", true);   
   myinitrequest.send(null);
}
 
//--------------------------------------------------
    Polling
//--------------------------------------------------

var doPolling = false;
var pollingTimeout = 200;

function startPolling ( onTickFunction )
{
  doPolling = true;
  onePollingCycle( onTickFunction )
}

function onePollingCycle ( onTickFunction )
{
  var mygetrequest=new XMLHttpRequest();
  
  mygetrequest.onreadystatechange = function() {
      if (mygetrequest.readyState!=4 || mygetrequest.status!=200 ) return;        

      var data = JSON.parse(mygetrequest.responseText);
    
      onTickFunction(data);
  };
            
  var req = "EUR_USD";
  if (allRates)
  {
     req = "";
     for(var i = 0; i < availablePairs.length; i++)
     {
       if ( req.length > 0 ) req += ",";
       var pair = availablePairs[i];
       var splitp = splitName( pair )
       req += splitp[0] + "_" + splitp[1];
     }
  }
  
  mygetrequest.open("GET", "http://api-sandbox.oanda.com/v1/instruments/price?instruments=" + req, true);
  mygetrequest.send(null);
                          
  if ( doPolling )  
  {
    setTimeout( function() { onePollingCycle(onTickFunction); }, pollingTimeout );
  }
}


function endPolling ()
{
  doPolling = false;
}

//--------------------------------------------------
    Streaming
//--------------------------------------------------

var streamingSocket;

function startStreaming ( onTickFunction )
{
  streamingSocket = io.connect('http://api-sandbox.oanda.com', {'force new connection':true , resource:'ratestream'});   // forcing due to socket.io bug
  
  streamingSocket.on('connect', function () {
  
    var currencyList = ['EUR/USD'];
    if ( allRates ) currencyList = availablePairs;
    
    streamingSocket.emit('subscribe', {'instruments': currencyList});

    streamingSocket.on('tick', function (data) {
      onTickFunction( data );
    });
  });
}

function endStreaming ()
{
  streamingSocket.disconnect();
  streamingSocket.removeAllListeners();
}

 
//--------------------------------------------------
    UI
//--------------------------------------------------

// fix jquery vs chrome bug "event.layerX & event.layerY will be removed from WebKit soon"
var i;
if ( ~(i = $.inArray('layerX', $.event.props)) ) {
    $.event.props.splice(i, 2);
}

function initRaphael ( divTag )
{
    var _paper = Raphael( document.getElementById( divTag ), 750, 330 );

    // The Raphael SVG canvas.
    var _canvas = _paper.canvas;

    // The HTML element that contains the canvas.
    var _container = $(_canvas).parent();

    var _rectValues = _paper.rect(0, 0, 330, 285, 3).attr({
                    stroke: "none",
                    fill: "#FFFFFF"
                  });
                
    var squares = {};
      
    for ( var i = 0; i < currencies.length; i++)
    {
        _paper.text( 25, i*15 + 7, currencies[i] );
        
        for ( var p = 0; p < currencies.length; p++ )
        {
            //var fill = Raphael.rgb( p*200/currencies.length + 50, i*200/currencies.length + 50, 128 );
            var nextRect = _paper.rect( 50 + p*14, i*15, 14, 15, 1 ).attr({
                               stroke: "none",
                               fill:   "#CCCCCC"
                           });
                   
            squares[ currencies[i]+"/"+currencies[p] ] = nextRect;
        }
    }    
    
    return squares;
}

var squaresStream = {};
var squaresPoll   = {};

var oldValuesStream = {};
var oldValuesPoll   = {};

var oldTimeStream = 0;
var oldTimePoll = 0;

function onTickStream ( data )
{
  console.log("Stream tick:" + data.instrument + " " + data.bid);
  
  var fill     = "#AAAAAA";
  var nextFill = "#999999";
  if ( oldValuesStream[data.instrument]  != undefined )
  {
    if ( data.bid > oldValuesStream[data.instrument] ) { fill = "#00FF00"; nextFill = "#00CC00"; }
    if ( data.bid < oldValuesStream[data.instrument] ) { fill = "#FF0000"; nextFill = "#CC0000"; }
  }
  oldValuesStream[data.instrument] = data.bid;
  
  var rect = squaresStream[data.instrument];
  rect.attr({ "fill": fill });
  
  if ( data.instrument == "EUR/USD" )
  {
     oldTimeStream = data.timestamp*1000000 + data.timeusec;
  }
  
  setTimeout( function() { rect.attr({ "fill": nextFill }); }, 90 );
}

function onTickPoll ( data )
{
  for ( var i = 0; i < data.prices.length; i++)
  {
     var pair  = data.prices[i].instrument;
     var instr = pair.replace("_","/");
     var bid   = data.prices[i].bid;
     console.log("Poll tick:" + pair + " " + bid);

     var fill     = "#AAAAAA";
     var nextFill = "#999999";
     if ( oldValuesPoll[instr]  != undefined )
     {
       if ( bid > oldValuesPoll[instr] ) { fill = "#00FF00"; nextFill = "#00CC00"; }
       if ( bid < oldValuesPoll[instr] ) { fill = "#FF0000"; nextFill = "#CC0000"; }
     }
     oldValuesPoll[instr] = bid;
          
     if ( instr == "EUR/USD" )
     {
       oldTimePoll = data.prices[i].time * 1000000;
     }
     
     var rect = squaresPoll[instr];
     rect.attr({ "fill": fill });       
     setTimeout( function() {
                   var _rect = rect;
                   var _fill = nextFill;
                   return function() {
                     _rect.attr({ "fill": _fill });
                   }
                 }(), 90 );                                       
  }  
}


function checkPollDelay ()
{
  str = "";
  if (oldTimePoll != oldTimeStream )
  {  
     if ( oldTimeStream > oldTimePoll )
       str = "EUR/USD: Streamign newer by " + (oldTimeStream - oldTimePoll) + " usec";
     else
       str = "EUR/USD: polling is newer by " + (oldTimePoll - oldTimeStream) + " usec";     
  }
  
  document.getElementById("comparision").innerHTML = str;
  
  //setTimeout( checkPollDelay , 15 );
}

function startUI ( checkboxPoll, checkboxStream, ratePick, pollRate ) {

   $(checkboxPoll).click(function() {
     if($(this).is(":checked")) { startPolling( onTickPoll ); } else { endPolling(); }
   });

   $(checkboxStream).click(function() {
     if($(this).is(":checked")) { startStreaming( onTickStream ); } else { endStreaming(); }
   });
  
   $(ratePick).change(function() {
      allRates = !allRates;
      if ( allRates ) console.log("getting all rates"); else console.log("getting EUR/USD only");
      
      if ( $(checkboxStream).is(":checked") )
      {
        endStreaming();
        startStreaming( onTickStream );
      }
      
   });
   
   $(pollRate).change(function() {
     var selected = $(pollRate + " input[type='radio']:checked");
     pollingTimeout = selected.val();
   });
   
   squaresStream = initRaphael( "streamAPI" );
   squaresPoll   = initRaphael( "restAPI" );
   
   //checkPollDelay();       
}
 </script>
</head>
<body>
 <div id="initlist"></div>
 <div id="control">
   <input type="checkbox" id="ratePoll" /><label for="ratePoll">Polling rates</label>
   <input type="checkbox" id="rateStream" /><label for="rateStream">Streaming rates</label>
   <form>
     <div id="radioRatePick">
       <input type="radio" id="radio1" name="ratePick" checked="checked" /><label for="radio1">All rates</label>
       <input type="radio" id="radio2" name="ratePick" /><label for="radio2">EUR/USD only</label>
     </div>
   </form>   
   <form>
     <div id="radioPollTimeout">
       <input type="radio" id="radioP1" name="pollRate" value="100"/><label for="radioP1">10 req/sec</label>
       <input type="radio" id="radioP2" name="pollRate" value="200" checked="checked" /><label for="radio2">5 req/sec</label>
       <input type="radio" id="radioP3" name="pollRate" value="1000"/><label for="radioP3">1 req/sec</label>       
       <input type="radio" id="radioP4" name="pollRate" value="2000"/><label for="radioP4">0.5 req/sec</label>       
     </div>
   </form>   
 </div>
 <br>
 <div id="comparision"></div>
 <br> 
 <div id="rates">
  <table width="800"><tr><td width="400">
   Streaming:<br><BR>
   <div id="streamAPI"><div>
  </td>
  <td width="400">
   Polling:<br><BR>
   <div id="restAPI"><div>
  </td></tr></table>
 </div>
 <script>
   var allRates = true;
     
   startUI("#ratePoll", "#rateStream", "#radioRatePick", "#radioPollTimeout");
   
   getInstruments(false);
   
 </script>
</body>
<html>


